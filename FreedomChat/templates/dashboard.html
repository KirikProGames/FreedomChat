<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div style="position: relative; z-index: 2;">
            <h1 class="dashboard-title">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ current_user.username or current_user.email.split('@')[0] }}!</h1>
            <p class="dashboard-subtitle">–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å –≤ FreedomChat</p>
        </div>
        <div style="display: flex; gap: 12px; position: relative; z-index: 2; flex-wrap: wrap; margin-top: 20px;">
            <a href="{{ url_for('profile') }}" class="btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                üë§ –ü—Ä–æ—Ñ–∏–ª—å
            </a>
            <a href="{{ url_for('logout') }}" class="btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                üö™ –í—ã–π—Ç–∏
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="dashboard-content">
        <!-- Search Users Card -->
        <div class="feature-card">
            <div class="feature-icon">üîç</div>
            <h3 class="feature-title">–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
            
            <div class="form-group">
                <input type="text" id="user-search" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ email..." 
                       oninput="searchUsers(this.value)">
            </div>
            
            <div id="search-results" style="max-height: 300px; overflow-y: auto;">
                <!-- Results will appear here -->
            </div>
            
            <div id="search-info" style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-top: 12px; display: none;">
                üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞
            </div>
        </div>

        <!-- Create Chat Card -->
        <div class="feature-card">
            <div class="feature-icon">üí¨</div>
            <h3 class="feature-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</h3>
            
            <form method="POST" action="{{ url_for('create_chat') }}">
                <div class="form-group">
                    <input type="text" name="chat_name" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞" required
                           maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìã –¢–∏–ø —á–∞—Ç–∞</label>
                    <select name="chat_type" class="form-input">
                        <option value="group">üë• –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</option>
                        <option value="channel">üì¢ –ö–∞–Ω–∞–ª</option>
                        <option value="private_channel">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <input type="checkbox" name="is_private" id="is_private" style="transform: scale(1.2);">
                    <label for="is_private" style="font-weight: 500; color: var(--text-primary);">
                        üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç (—Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–¥—É)
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üöÄ –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
                </button>
            </form>
        </div>

        <!-- Join Chat Card -->
        <div class="feature-card">
            <div class="feature-icon">üîë</div>
            <h3 class="feature-title">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</h3>
            
            <form method="POST" action="{{ url_for('join_chat') }}">
                <div class="form-group">
                    <input type="text" name="code" class="form-input" placeholder="–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è" required
                           pattern="[A-Za-z0-9]{6}" title="–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </form>

            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="text-align: center; color: var(--text-secondary); font-size: 14px;">
                    üí° –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∫–æ–¥ —É –¥—Ä—É–≥–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
                </div>
            </div>
        </div>

        <!-- Chat List -->
        <div class="feature-card" style="grid-column: 1 / -1;">
            <div class="feature-icon">üí≠</div>
            <h3 class="feature-title">
                –í–∞—à–∏ —á–∞—Ç—ã 
                <span style="background: var(--primary-orange); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-left: 8px;">
                    {{ chat_rooms|length }}
                </span>
            </h3>

            {% if chat_rooms %}
            <div class="chats-list">
                {% for room in chat_rooms %}
                <div class="chat-item" onclick="openChat({{ room.id }})">
                    <div class="chat-avatar" style="background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        {% if room.is_direct %}
                        üë§
                        {% else %}
                        {{ room.name[0] | upper }}
                        {% endif %}
                    </div>
                    <div class="chat-preview">
                        <div class="chat-name">
                            {{ room.name }}
                            {% if room.is_direct %}
                            <span style="font-size: 12px; color: var(--text-secondary);">–õ–°</span>
                            {% endif %}
                        </div>
                        <div class="last-message">
                            üë• {{ room.members|length }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                            {% if room.is_private and not room.is_direct %}
                            ‚Ä¢ üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üò¥</div>
                <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 20px;">
                    –ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
                </h4>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">
                    –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —á–∞—Ç –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
let searchTimeout = null;

function searchUsers(query) {
    const resultsContainer = document.getElementById('search-results');
    const searchInfo = document.getElementById('search-info');
    
    if (!query.trim()) {
        resultsContainer.innerHTML = '';
        searchInfo.style.display = 'block';
        return;
    }
    
    searchInfo.style.display = 'none';
    resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">–ü–æ–∏—Å–∫...</div>';
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`/search_users?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => {
                displaySearchResults(users);
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            });
    }, 300);
}

function displaySearchResults(users) {
    const resultsContainer = document.getElementById('search-results');
    
    if (users.length === 0) {
        resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">üòî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    resultsContainer.innerHTML = users.map(user => `
        <div class="chat-item" onclick="createDM(${user.id})">
            <div class="chat-avatar" style="background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                ${user.username ? user.username[0].toUpperCase() : 'üë§'}
            </div>
            <div class="chat-preview">
                <div class="chat-name">
                    ${user.username || '–ë–µ–∑ –∏–º–µ–Ω–∏'}
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${user.online ? 'var(--success)' : 'var(--text-muted)'}; display: inline-block; margin-left: 8px;"></span>
                </div>
                <div class="last-message">${user.email}</div>
            </div>
        </div>
    `).join('');
}

function createDM(userId) {
    window.location.href = `/create_dm/${userId}`;
}

function openChat(chatId) {
    window.location.href = `/chat/${chatId}`;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('search-info').style.display = 'block';
});
</script>
{% endblock %}
