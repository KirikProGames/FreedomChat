{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div style="position: relative; z-index: 2;">
            <h1 class="dashboard-title">‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ current_user.username or current_user.email.split('@')[0] }}!</h1>
            <p class="dashboard-subtitle">–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞ –≤ FreedomChat</p>
        </div>
        <div style="display: flex; gap: 12px; position: relative; z-index: 2; flex-wrap: wrap;">
            <a href="{{ url_for('profile') }}" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                üë§ –ü—Ä–æ—Ñ–∏–ª—å
            </a>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                üö™ –í—ã–π—Ç–∏
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="dashboard-content">
        <!-- Search Users Card -->
        <div class="feature-card">
            <div class="feature-icon">üîç</div>
            <h3 class="feature-title">–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
            
            <div class="form-group">
                <input type="text" id="user-search" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ email..." 
                       oninput="searchUsers(this.value)">
            </div>
            
            <div id="search-results" style="max-height: 300px; overflow-y: auto;">
                <!-- Results will appear here -->
            </div>
            
            <div id="search-info" style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-top: 12px; display: none;">
                üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞
            </div>
        </div>

        <!-- Create Chat Card -->
        <div class="feature-card">
            <div class="feature-icon">üÜï</div>
            <h3 class="feature-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</h3>
            
            <form method="POST" action="{{ url_for('create_chat') }}">
                <div class="form-group">
                    <input type="text" name="chat_name" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞" required
                           maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìã –¢–∏–ø —á–∞—Ç–∞</label>
                    <select name="chat_type" class="form-input">
                        <option value="group">üë• –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</option>
                        <option value="channel">üì¢ –ö–∞–Ω–∞–ª</option>
                        <option value="private_channel">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <input type="checkbox" name="is_private" id="is_private" style="transform: scale(1.2);">
                    <label for="is_private" style="font-weight: 500; color: var(--text-primary);">
                        üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç (—Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–¥—É)
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üöÄ –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
                </button>
            </form>
        </div>

        <!-- Join Chat Card -->
        <div class="feature-card">
            <div class="feature-icon">üîë</div>
            <h3 class="feature-title">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</h3>
            
            <form method="POST" action="{{ url_for('join_chat') }}">
                <div class="form-group">
                    <input type="text" name="code" class="form-input" placeholder="–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è" required
                           pattern="[A-Za-z0-9]{6}" title="–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </form>

            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="text-align: center; color: var(--text-secondary); font-size: 14px;">
                    üí° –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∫–æ–¥ —É –¥—Ä—É–≥–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="feature-card">
            <div class="feature-icon">‚ö°</div>
            <h3 class="feature-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            
            <div style="display: grid; gap: 12px;">
                <a href="{{ url_for('profile') }}" class="btn btn-secondary" style="justify-content: start; gap: 12px;">
                    üë§ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                </a>
                
                <button class="btn btn-secondary" style="justify-content: start; gap: 12px;" onclick="toggleTheme()">
                    üåô –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
                </button>
                
                <button class="btn btn-secondary" style="justify-content: start; gap: 12px;" onclick="testNotification()">
                    üîî –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                </button>

                <button class="btn btn-secondary" style="justify-content: start; gap: 12px;" onclick="showKeyboardShortcuts()">
                    ‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
                </button>
            </div>
        </div>

        <!-- Chat List Card -->
        <div class="feature-card" style="grid-column: 1 / -1;">
            <div class="feature-icon">üí¨</div>
            <h3 class="feature-title">
                –í–∞—à–∏ —á–∞—Ç—ã 
                <span style="background: var(--gradient); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-left: 8px;">
                    {{ chat_rooms|length }}
                </span>
            </h3>

            {% if chat_rooms %}
            <div class="chats-grid">
                {% for room in chat_rooms %}
                <div class="chat-card" onclick="openChat({{ room.id }})">
                    <div class="chat-avatar">
                        {% if room.is_direct %}
                        üë§
                        {% else %}
                        {{ room.name[0] | upper }}
                        {% endif %}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">
                            {{ room.name }}
                            {% if room.is_direct %}
                            <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">–õ–°</span>
                            {% endif %}
                        </div>
                        <div class="chat-meta">
                            <span>üë• {{ room.members|length }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                            {% if room.is_private and not room.is_direct %}
                            <span>üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</span>
                            <span>–ö–æ–¥: {{ room.code }}</span>
                            {% endif %}
                            {% if room.is_direct %}
                            <span>üíå –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="chat-actions">
                        {% if not room.is_direct %}
                        <a href="{{ url_for('video_call', chat_id=room.id) }}" class="btn-call" 
                           title="–ù–∞—á–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫" onclick="event.stopPropagation()">
                            üìû
                        </a>
                        {% endif %}
                        <a href="{{ url_for('chat', chat_id=room.id) }}" class="btn-open">
                            üí¨
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üò¥</div>
                <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 20px;">
                    –ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
                </h4>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">
                    –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —á–∞—Ç –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É
                </p>
                <div style="display: grid; gap: 12px; max-width: 300px; margin: 0 auto;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                        <span style="font-size: 20px;">üí°</span>
                        <span style="font-size: 14px; color: var(--text-primary);">
                            <strong>–°–æ–≤–µ—Ç:</strong> –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫
                        </span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                        <span style="font-size: 20px;">üí°</span>
                        <span style="font-size: 14px; color: var(--text-primary);">
                            <strong>–°–æ–≤–µ—Ç:</strong> –°–æ–∑–¥–∞–π—Ç–µ –õ–° –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è
                        </span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.chat-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.btn-call {
    background: var(--success);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 16px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn-call:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-open {
    background: var(--primary);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 16px;
    transition: all 0.3s ease;
}

.btn-open:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

/* Search Results */
.search-result {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.search-result:hover {
    background: var(--bg-primary);
    transform: translateX(4px);
}

.search-result-avatar {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
}

.search-result-info {
    flex: 1;
}

.search-result-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.search-result-email {
    font-size: 12px;
    color: var(--text-secondary);
}

.search-result-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.search-result-status.online {
    background: var(--success);
}

.search-result-status.offline {
    background: var(--secondary);
}

.no-results {
    text-align: center;
    padding: 20px;
    color: var(--text-secondary);
    font-size: 14px;
}

.loading-results {
    text-align: center;
    padding: 20px;
    color: var(--text-secondary);
}

.loading-results::after {
    content: '...';
    animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
    0%, 20% { color: var(--text-secondary); text-shadow: none; }
    50% { color: var(--primary); text-shadow: 0 0 5px var(--primary); }
    100% { color: var(--text-secondary); text-shadow: none; }
}
</style>

<script>
// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
let searchTimeout = null;

function searchUsers(query) {
    const resultsContainer = document.getElementById('search-results');
    const searchInfo = document.getElementById('search-info');
    
    if (!query.trim()) {
        resultsContainer.innerHTML = '';
        searchInfo.style.display = 'block';
        return;
    }
    
    searchInfo.style.display = 'none';
    resultsContainer.innerHTML = '<div class="loading-results">–ü–æ–∏—Å–∫</div>';
    
    // Debounce –ø–æ–∏—Å–∫–∞
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`/search_users?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => {
                displaySearchResults(users);
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            });
    }, 300);
}

function displaySearchResults(users) {
    const resultsContainer = document.getElementById('search-results');
    
    if (users.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results">üòî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    resultsContainer.innerHTML = users.map(user => `
        <div class="search-result" onclick="openUserProfile(${user.id})">
            <div class="search-result-avatar">
                ${user.username ? user.username[0].toUpperCase() : 'üë§'}
            </div>
            <div class="search-result-info">
                <div class="search-result-name">${user.username || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                <div class="search-result-email">${user.email}</div>
            </div>
            <div class="search-result-status ${user.online ? 'online' : 'offline'}"></div>
        </div>
    `).join('');
}

function openUserProfile(userId) {
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    window.location.href = `/profile/${userId}`;
}

function openChat(chatId) {
    window.location.href = `/chat/${chatId}`;
}

function testNotification() {
    if ('Notification' in window) {
        if (Notification.permission === 'granted') {
            new Notification('FreedomChat', { 
                body: '–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!', 
                icon: '/static/favicon.ico' 
            });
        } else if (Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    new Notification('FreedomChat', { 
                        body: '–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!', 
                        icon: '/static/favicon.ico' 
                    });
                }
            });
        }
    }
    
    showNotification('–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'üîî –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!', 'success');
}

function showKeyboardShortcuts() {
    showNotification('–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏', 
        '‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:\n\n' +
        'Ctrl+Enter - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ\n' +
        'Ctrl+/ - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n' +
        'Esc - –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞\n\n' +
        '–ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö:\n' +
        '–¢–∞–ø –ø–æ —á–∞—Ç—É - –æ—Ç–∫—Ä—ã—Ç—å\n' +
        '–°–≤–∞–π–ø - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è', 
        'info'
    );
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('search-info').style.display = 'block';
    
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('user-search');
    if (searchInput) {
        searchInput.focus();
    }
});
</script>
{% endblock %}
