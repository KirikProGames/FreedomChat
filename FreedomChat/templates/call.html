{% extends "base.html" %}

{% block content %}
<div class="call-container">
    <!-- Header -->
    <div class="call-header">
        <div style="display: flex; align-items: center; gap: 16px;">
            <a href="{{ url_for('chat', chat_id=chat_room.id) }}" class="btn btn-secondary" 
               style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; padding: 10px;">
                ‚Üê –ù–∞–∑–∞–¥ –≤ —á–∞—Ç
            </a>
            <div>
                <h1 style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">
                    üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –≤ {{ chat_room.name }}
                </h1>
                <div style="font-size: 14px; opacity: 0.9;" id="call-status">
                    üîí Jitsi Meet ‚Ä¢ –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; align-items: center;">
            <div class="call-timer" id="call-timer">00:00</div>
            <button class="btn btn-secondary" onclick="showInviteModal()" 
                    style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                üìã –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
            </button>
            <button class="btn btn-secondary" onclick="toggleFullscreen()" 
                    style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                ‚õ∂ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
            </button>
        </div>
    </div>

    <!-- Jitsi Meet Container -->
    <div id="jitsi-container" style="width: 100%; height: calc(100vh - 200px); background: var(--bg-secondary); border-radius: 16px; overflow: hidden; position: relative;">
        <!-- Loading State -->
        <div id="loading-state" style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; gap: 20px; padding: 40px;">
            <div style="font-size: 64px;">üé•</div>
            <h2 style="color: var(--text-primary); margin-bottom: 8px; text-align: center;">–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ FreedomChat</h2>
            <p style="color: var(--text-secondary); text-align: center; max-width: 500px; line-height: 1.6;">
                –ò—Å–ø–æ–ª—å–∑—É–µ–º <strong>Jitsi Meet</strong> –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ —Å –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–≤—è–∑—å—é<br>
                ‚úÖ –ì–æ–ª–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Ä¢ ‚úÖ –í–∏–¥–µ–æ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Ä¢ ‚úÖ –ë–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0; width: 100%; max-width: 400px;">
                <div style="text-align: center; padding: 16px; background: var(--bg-primary); border-radius: 12px;">
                    <div style="font-size: 24px; margin-bottom: 8px;">üé§</div>
                    <div style="font-size: 14px; font-weight: 600;">–ì–æ–ª–æ—Å</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--bg-primary); border-radius: 12px;">
                    <div style="font-size: 24px; margin-bottom: 8px;">üîí</div>
                    <div style="font-size: 14px; font-weight: 600;">–ë–µ–∑–æ–ø–∞—Å–Ω–æ</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--bg-primary); border-radius: 12px;">
                    <div style="font-size: 24px; margin-bottom: 8px;">üìπ</div>
                    <div style="font-size: 14px; font-weight: 600;">–í–∏–¥–µ–æ</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">HD –∫–∞—á–µ—Å—Ç–≤–æ</div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                <button class="btn btn-primary" onclick="startJitsiCall()" style="min-width: 160px;">
                    üöÄ –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
                <button class="btn btn-secondary" onclick="testAudioVideo()" style="min-width: 160px;">
                    üéõÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                </button>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: var(--bg-primary); border-radius: 12px; max-width: 400px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="font-size: 20px;">üí°</span>
                    <strong style="color: var(--text-primary);">–°–æ–≤–µ—Ç:</strong>
                </div>
                <p style="font-size: 14px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                    –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∫–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –ø–æ–ø—Ä–æ—Å–∏—Ç
                </p>
            </div>
        </div>

        <!-- Jitsi will be loaded here -->
    </div>

    <!-- Quick Controls -->
    <div class="call-controls" id="quick-controls" style="display: none;">
        <button class="control-btn" id="toggle-audio" onclick="toggleAudio()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
            üé§
        </button>
        <button class="control-btn" id="toggle-video" onclick="toggleVideo()" title="–ö–∞–º–µ—Ä–∞">
            üìπ
        </button>
        <button class="control-btn" id="toggle-screen" onclick="toggleScreenShare()" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞">
            üñ•Ô∏è
        </button>
        <button class="control-btn end-call-btn" onclick="endJitsiCall()" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
            üìû
        </button>
        <button class="control-btn" onclick="toggleChat()" title="–ß–∞—Ç">
            üí¨
        </button>
        <button class="control-btn" onclick="toggleParticipants()" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
            üë•
        </button>
    </div>

    <!-- Invite Modal -->
    <div id="invite-modal" class="call-modal" style="display: none;">
        <div class="call-modal-content">
            <div class="call-modal-icon">üì®</div>
            <h2>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –∑–≤–æ–Ω–æ–∫</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px; text-align: center;">
                –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–∞—Ç–∞. –û–Ω–∏ —Å–º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∑–≤–æ–Ω–∫—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ.
            </p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 24px;">
                <input type="text" id="invite-link" readonly 
                       style="flex: 1; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;"
                       value="{{ url_for('video_call', chat_id=chat_room.id, _external=True ) }}">
                <button onclick="copyInviteLink()" class="btn btn-primary" style="white-space: nowrap;">
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>

            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 16px;">üí°</span>
                    <strong style="color: var(--text-primary); font-size: 14px;">–ë—ã—Å—Ç—Ä—ã–µ —Å–ø–æ—Å–æ–±—ã –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å:</strong>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="shareTelegram()" style="font-size: 12px; padding: 8px 12px;">
                        üì± Telegram
                    </button>
                    <button class="btn btn-secondary" onclick="shareWhatsApp()" style="font-size: 12px; padding: 8px 12px;">
                        üí¨ WhatsApp
                    </button>
                    <button class="btn btn-secondary" onclick="copyToClipboardWithNotification()" style="font-size: 12px; padding: 8px 12px;">
                        üìß Email
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeInviteModal()" class="btn btn-secondary">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- Device Test Modal -->
    <div id="device-test-modal" class="call-modal" style="display: none;">
        <div class="call-modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 20px;">üéõÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                <!-- Camera Test -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 12px; color: var(--text-primary);">üìπ –ö–∞–º–µ—Ä–∞</h4>
                    <video id="camera-test" autoplay muted style="width: 100%; height: 120px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 12px;"></video>
                    <select id="camera-select" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); margin-bottom: 8px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>
                    </select>
                    <button onclick="testCamera()" class="btn btn-secondary" style="width: 100%; font-size: 12px; padding: 8px;">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–º–µ—Ä—É
                    </button>
                </div>

                <!-- Microphone Test -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 12px; color: var(--text-primary);">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</h4>
                    <div id="audio-level" style="height: 120px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 12px; display: flex; align-items: end; padding: 8px;">
                        <div id="audio-visualizer" style="background: var(--primary); width: 100%; height: 0%; border-radius: 4px; transition: height 0.1s;"></div>
                    </div>
                    <select id="microphone-select" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); margin-bottom: 8px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω...</option>
                    </select>
                    <button onclick="testMicrophone()" class="btn btn-secondary" style="width: 100%; font-size: 12px; padding: 8px;">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeDeviceTest()" class="btn btn-primary">
                    –ì–æ—Ç–æ–≤–æ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Jitsi Meet API -->
<script src="https://meet.jit.si/external_api.js"></script>

<script>
// Jitsi Meet Integration
let jitsiApi = null;
let callStartTime = null;
let callTimer = null;
let audioContext = null;
let analyser = null;
let microphone = null;
let javascriptNode = null;

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∫–æ–º–Ω–∞—Ç—ã
const roomName = `FreedomChat-{{ chat_room.id }}-{{ chat_room.name|replace(" ", "-")|replace(/[^a-zA-Z0-9-]/g, "") }}-${Date.now()}`;

// –ó–∞–ø—É—Å–∫ Jitsi –∑–≤–æ–Ω–∫–∞
function startJitsiCall() {
    try {
        updateCallStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Jitsi Meet...');
        
        const domain = 'meet.jit.si';
        const options = {
            roomName: roomName,
            width: '100%',
            height: '100%',
            parentNode: document.getElementById('jitsi-container'),
            configOverwrite: {
                prejoinPageEnabled: false,
                startWithAudioMuted: false,
                startWithVideoMuted: false,
                disableModeratorIndicator: false,
                startScreenSharing: false,
                enableEmailInStats: false,
                enableWelcomePage: false,
                enableClosePage: false,
                defaultLanguage: 'ru',
                disableThirdPartyRequests: true,
                enableNoAudioDetection: true,
                enableNoisyMicDetection: true,
                resolution: 720,
                constraints: {
                    video: {
                        height: { ideal: 720, max: 1080, min: 240 }
                    }
                }
            },
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                    'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                    'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                    'videoquality', 'filmstrip', 'invite', 'feedback', 'stats', 'shortcuts',
                    'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
                    'mute-video-everyone', 'security'
                ],
                SETTINGS_SECTIONS: ['devices', 'language', 'moderator', 'profile', 'calendar'],
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                SHOW_BRAND_WATERMARK: false,
                BRAND_WATERMARK_LINK: '',
                SHOW_POWERED_BY: false,
                SHOW_PROMOTIONAL_CLOSE_PAGE: false,
                SHOW_CHROME_EXTENSION_BANNER: false,
                MOBILE_APP_PROMO: false,
                HIDE_INVITE_MORE_HEADER: false,
                DISABLE_VIDEO_BACKGROUND: false,
                DISABLE_FOCUS_INDICATOR: false,
                DISABLE_DOMINANT_SPEAKER_INDICATOR: false,
                VERTICAL_FILMSTRIP: true,
                CLOSE_PAGE_GUEST_HINT: false,
                SHOW_DEEP_LINKING_IMAGE: false,
                GENERATE_ROOMNAMES_ON_WELCOME_PAGE: false,
                DISPLAY_WELCOME_PAGE_CONTENT: false,
                APP_NAME: 'FreedomChat',
                NATIVE_APP_NAME: 'FreedomChat',
                DEFAULT_BACKGROUND: '#0f172a'
            },
            userInfo: {
                displayName: '{{ current_user.username or current_user.email.split("@")[0] }}',
                email: '{{ current_user.email }}'
            }
        };

        // –°–∫—Ä—ã–≤–∞–µ–º loading state
        document.getElementById('loading-state').style.display = 'none';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Jitsi Meet
        jitsiApi = new JitsiMeetExternalAPI(domain, options);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Jitsi
        jitsiApi.addEventListener('videoConferenceJoined', () => {
            console.log('Joined conference');
            updateCallStatus('–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω');
            startCallTimer();
            document.getElementById('quick-controls').style.display = 'flex';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–£—Å–ø–µ—Ö', '–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫—É!', 'success');
        });

        jitsiApi.addEventListener('videoConferenceLeft', () => {
            console.log('Left conference');
            updateCallStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
            stopCallTimer();
            showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫', 'info');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —á–∞—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = "{{ url_for('chat', chat_id=chat_room.id) }}";
            }, 2000);
        });

        jitsiApi.addEventListener('participantJoined', (participant) => {
            console.log('Participant joined:', participant);
            showNotification('–£—á–∞—Å—Ç–Ω–∏–∫', `${participant.displayName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, 'info');
        });

        jitsiApi.addEventListener('participantLeft', (participant) => {
            console.log('Participant left:', participant);
            showNotification('–£—á–∞—Å—Ç–Ω–∏–∫', `${participant.displayName} –ø–æ–∫–∏–Ω—É–ª –∑–≤–æ–Ω–æ–∫`, 'warning');
        });

        jitsiApi.addEventListener('audioMuteStatusChanged', (muted) => {
            const btn = document.getElementById('toggle-audio');
            if (muted.muted) {
                btn.innerHTML = 'üé§‚ùå';
                btn.title = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
            } else {
                btn.innerHTML = 'üé§';
                btn.title = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
            }
        });

        jitsiApi.addEventListener('videoMuteStatusChanged', (muted) => {
            const btn = document.getElementById('toggle-video');
            if (muted.muted) {
                btn.innerHTML = 'üìπ‚ùå';
                btn.title = '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞';
            } else {
                btn.innerHTML = 'üìπ';
                btn.title = '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞';
            }
        });

        jitsiApi.addEventListener('screenSharingStatusChanged', (sharing) => {
            const btn = document.getElementById('toggle-screen');
            if (sharing.on) {
                btn.innerHTML = 'üñ•Ô∏è‚úÖ';
                btn.title = '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞';
            } else {
                btn.innerHTML = 'üñ•Ô∏è';
                btn.title = '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞';
            }
        });

    } catch (error) {
        console.error('Jitsi initialization error:', error);
        updateCallStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫', 'error');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–∞
        document.getElementById('loading-state').innerHTML += `
            <button class="btn btn-primary" onclick="startJitsiCall()" style="margin-top: 20px;">
                üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        `;
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–º
function toggleAudio() {
    if (jitsiApi) {
        jitsiApi.executeCommand('toggleAudio');
    }
}

function toggleVideo() {
    if (jitsiApi) {
        jitsiApi.executeCommand('toggleVideo');
    }
}

function toggleScreenShare() {
    if (jitsiApi) {
        jitsiApi.executeCommand('toggleShareScreen');
    }
}

function toggleChat() {
    if (jitsiApi) {
        jitsiApi.executeCommand('toggleChat');
    }
}

function toggleParticipants() {
    if (jitsiApi) {
        jitsiApi.executeCommand('toggleParticipants');
    }
}

function endJitsiCall() {
    if (jitsiApi) {
        jitsiApi.dispose();
    }
    window.location.href = "{{ url_for('chat', chat_id=chat_room.id) }}";
}

// –¢–∞–π–º–µ—Ä –∑–≤–æ–Ω–∫–∞
function startCallTimer() {
    callStartTime = Date.now();
    callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('call-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopCallTimer() {
    if (callTimer) {
        clearInterval(callTimer);
    }
}

// –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
function showInviteModal() {
    document.getElementById('invite-modal').style.display = 'flex';
}

function closeInviteModal() {
    document.getElementById('invite-modal').style.display = 'none';
}

function copyInviteLink() {
    const linkInput = document.getElementById('invite-link');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    showNotification('–£—Å–ø–µ—Ö', '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
}

function copyToClipboardWithNotification() {
    copyInviteLink();
}

function shareTelegram() {
    const text = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫—É –≤ FreedomChat: ${document.getElementById('invite-link').value}`;
    window.open(`https://t.me/share/url?url=${encodeURIComponent(document.getElementById('invite-link').value)}&text=${encodeURIComponent(text)}`, '_blank');
}

function shareWhatsApp() {
    const text = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫—É –≤ FreedomChat: ${document.getElementById('invite-link').value}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

// –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error('Fullscreen error:', err);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
async function testAudioVideo() {
    document.getElementById('device-test-modal').style.display = 'flex';
    await loadDevices();
}

function closeDeviceTest() {
    document.getElementById('device-test-modal').style.display = 'none';
    stopMicrophoneTest();
    stopCameraTest();
}

async function loadDevices() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        const cameras = devices.filter(device => device.kind === 'videoinput');
        const microphones = devices.filter(device => device.kind === 'audioinput');
        
        const cameraSelect = document.getElementById('camera-select');
        const microphoneSelect = document.getElementById('microphone-select');
        
        cameraSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>';
        microphoneSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω...</option>';
        
        cameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera.deviceId;
            option.text = camera.label || `–ö–∞–º–µ—Ä–∞ ${cameraSelect.length}`;
            cameraSelect.appendChild(option);
        });
        
        microphones.forEach(microphone => {
            const option = document.createElement('option');
            option.value = microphone.deviceId;
            option.text = microphone.label || `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${microphoneSelect.length}`;
            microphoneSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading devices:', error);
    }
}

async function testCamera() {
    const cameraSelect = document.getElementById('camera-select');
    const cameraTest = document.getElementById('camera-test');
    
    if (cameraSelect.value) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: cameraSelect.value }
            });
            cameraTest.srcObject = stream;
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
        }
    }
}

function stopCameraTest() {
    const cameraTest = document.getElementById('camera-test');
    if (cameraTest.srcObject) {
        cameraTest.srcObject.getTracks().forEach(track => track.stop());
    }
}

async function testMicrophone() {
    const microphoneSelect = document.getElementById('microphone-select');
    
    if (microphoneSelect.value) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: { deviceId: microphoneSelect.value }
            });
            setupAudioVisualizer(stream);
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
        }
    }
}

function setupAudioVisualizer(stream) {
    try {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
        stopMicrophoneTest();
        
        // –°–æ–∑–¥–∞–µ–º AudioContext
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        
        analyser.fftSize = 256;
        microphone.connect(analyser);
        
        javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);
        
        javascriptNode.onaudioprocess = function() {
            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);
            
            let values = 0;
            for (let i = 0; i < array.length; i++) {
                values += array[i];
            }
            
            const average = values / array.length;
            const visualizer = document.getElementById('audio-visualizer');
            visualizer.style.height = Math.min(average * 2, 100) + '%';
        };
        
    } catch (error) {
        console.error('Audio visualizer error:', error);
    }
}

function stopMicrophoneTest() {
    if (javascriptNode) {
        javascriptNode.disconnect();
        javascriptNode = null;
    }
    if (microphone) {
        microphone.disconnect();
        microphone = null;
    }
    if (audioContext) {
        audioContext.close();
        audioContext = null;
    }
    if (analyser) {
        analyser.disconnect();
        analyser = null;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function updateCallStatus(status) {
    document.getElementById('call-status').textContent = status;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    setTimeout(() => {
        startJitsiCall();
    }, 1000);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (jitsiApi) {
            jitsiApi.dispose();
        }
        stopMicrophoneTest();
        stopCameraTest();
    });
});
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Jitsi */
#jitsi-container {
    border: 1px solid var(--border);
}

.call-controls {
    background: var(--bg-card);
    padding: 16px;
    display: none;
    justify-content: center;
    gap: 12px;
    border-top: 1px solid var(--border);
}

.control-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.control-btn:hover {
    transform: scale(1.1);
}

.end-call-btn {
    background: #ef4444;
    color: white;
}

.control-btn.active {
    background: var(--primary);
    color: white;
}

.call-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.call-modal-content {
    background: var(--bg-card);
    padding: 40px;
    border-radius: 24px;
    text-align: center;
    box-shadow: var(--shadow);
    max-width: 500px;
    width: 90%;
}

.call-modal-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .call-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .call-controls {
        padding: 12px;
        gap: 8px;
    }
    
    .control-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
    }
    
    .call-modal-content {
        padding: 24px;
        margin: 20px;
    }
}

@media (max-width: 480px) {
    #loading-state {
        padding: 20px;
    }
    
    .call-header h1 {
        font-size: 18px;
    }
    
    .call-timer {
        font-size: 12px;
        padding: 6px 12px;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.call-modal {
    animation: fadeIn 0.3s ease;
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è Jitsi */
.jitsi-container {
    border-radius: 16px !important;
    overflow: hidden !important;
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ */
.control-btn:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}
</style>
{% endblock %}
