{% extends "base.html" %}

{% block content %}
<div class="call-container">
    <!-- Header -->
    <div class="call-header">
        <div style="display: flex; align-items: center; gap: 16px;">
            <a href="{{ url_for('chat', chat_id=chat_room.id) }}" class="btn btn-secondary" 
               style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; padding: 10px;">
                ‚Üê –ù–∞–∑–∞–¥ –≤ —á–∞—Ç
            </a>
            <div>
                <h1 style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">
                    üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –≤ {{ chat_room.name }}
                </h1>
                <div style="font-size: 14px; opacity: 0.9;" id="call-status">
                    üîí Jitsi Meet ‚Ä¢ –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; align-items: center;">
            <div class="call-timer" id="call-timer">00:00</div>
            <button class="btn btn-secondary" onclick="copyRoomLink()" 
                    style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                üìã –ö–æ–º–Ω–∞—Ç–∞
            </button>
            <button class="btn btn-secondary" onclick="showInviteModal()" 
                    style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Jitsi Meet Container -->
    <div id="jitsi-container" style="width: 100%; height: calc(100vh - 200px); background: var(--bg-secondary); border-radius: 16px; overflow: hidden; position: relative;">
        <!-- Loading State -->
        <div id="loading-state" style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; gap: 20px; padding: 40px;">
            <div style="font-size: 64px;">üé•</div>
            <h2 style="color: var(--text-primary); margin-bottom: 8px; text-align: center;">–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ FreedomChat</h2>
            <p style="color: var(--text-secondary); text-align: center; max-width: 500px; line-height: 1.6;">
                –ò—Å–ø–æ–ª—å–∑—É–µ–º <strong>Jitsi Meet</strong> –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ —Å –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–≤—è–∑—å—é<br>
                ‚úÖ –ì–æ–ª–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Ä¢ ‚úÖ –í–∏–¥–µ–æ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Ä¢ ‚úÖ –ë–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            </p>
            
            <!-- Room Info -->
            <div id="room-info" style="background: var(--bg-primary); padding: 16px; border-radius: 12px; margin: 10px 0; max-width: 400px; width: 100%;">
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                    <strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> <span id="room-name-display">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    üí° –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –≤ –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                </div>
            </div>

            <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                <button class="btn btn-primary" onclick="startJitsiCall()" style="min-width: 160px;">
                    üöÄ –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
                <button class="btn btn-secondary" onclick="testAudioVideo()" style="min-width: 160px;">
                    üéõÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Controls -->
    <div class="call-controls" id="quick-controls" style="display: none;">
        <button class="control-btn" id="toggle-audio" onclick="toggleAudio()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
            üé§
        </button>
        <button class="control-btn" id="toggle-video" onclick="toggleVideo()" title="–ö–∞–º–µ—Ä–∞">
            üìπ
        </button>
        <button class="control-btn" id="toggle-screen" onclick="toggleScreenShare()" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞">
            üñ•Ô∏è
        </button>
        <button class="control-btn end-call-btn" onclick="endJitsiCall()" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
            üìû
        </button>
        <button class="control-btn" onclick="toggleChat()" title="–ß–∞—Ç">
            üí¨
        </button>
    </div>
</div>

<!-- Jitsi Meet API -->
<script src="https://meet.jit.si/external_api.js"></script>

<script>
// Jitsi Meet Integration
let jitsiApi = null;
let callStartTime = null;
let callTimer = null;

// –û–î–ò–ù–ê–ö–û–í–ê–Ø –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞!
const roomName = `FreedomChat-Room-{{ chat_room.id }}`;

// –ó–∞–ø—É—Å–∫ Jitsi –∑–≤–æ–Ω–∫–∞
function startJitsiCall() {
    try {
        updateCallStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫—É...');
        document.getElementById('room-name-display').textContent = roomName;
        
        const domain = 'meet.jit.si';
        const options = {
            roomName: roomName,
            width: '100%',
            height: '100%',
            parentNode: document.getElementById('jitsi-container'),
            configOverwrite: {
                prejoinPageEnabled: false,
                startWithAudioMuted: false,
                startWithVideoMuted: false,
                disableModeratorIndicator: false,
                startScreenSharing: false,
                enableEmailInStats: false,
                enableWelcomePage: false,
                enableClosePage: false,
                defaultLanguage: 'ru',
                disableThirdPartyRequests: true,
                enableNoAudioDetection: true,
                enableNoisyMicDetection: true,
                resolution: 720
            },
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                    'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                    'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                    'videoquality', 'filmstrip', 'invite', 'feedback', 'stats', 'shortcuts',
                    'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
                    'security'
                ],
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                SHOW_BRAND_WATERMARK: false,
                BRAND_WATERMARK_LINK: '',
                SHOW_POWERED_BY: false,
                APP_NAME: 'FreedomChat',
                NATIVE_APP_NAME: 'FreedomChat'
            },
            userInfo: {
                displayName: '{{ current_user.username or current_user.email.split("@")[0] }}',
                email: '{{ current_user.email }}'
            }
        };

        document.getElementById('loading-state').style.display = 'none';
        
        jitsiApi = new JitsiMeetExternalAPI(domain, options);
        
        jitsiApi.addEventListener('videoConferenceJoined', () => {
            console.log('Joined conference:', roomName);
            updateCallStatus('–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω ‚Ä¢ –ö–æ–º–Ω–∞—Ç–∞: ' + roomName);
            startCallTimer();
            document.getElementById('quick-controls').style.display = 'flex';
            showNotification('–£—Å–ø–µ—Ö', '–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫—É!', 'success');
        });

        jitsiApi.addEventListener('videoConferenceLeft', () => {
            console.log('Left conference');
            updateCallStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
            stopCallTimer();
            setTimeout(() => {
                window.location.href = "{{ url_for('chat', chat_id=chat_room.id) }}";
            }, 2000);
        });

        jitsiApi.addEventListener('participantJoined', (participant) => {
            console.log('Participant joined:', participant);
            showNotification('–£—á–∞—Å—Ç–Ω–∏–∫', `${participant.displayName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∑–≤–æ–Ω–∫—É`, 'info');
        });

        jitsiApi.addEventListener('participantLeft', (participant) => {
            console.log('Participant left:', participant);
            showNotification('–£—á–∞—Å—Ç–Ω–∏–∫', `${participant.displayName} –ø–æ–∫–∏–Ω—É–ª –∑–≤–æ–Ω–æ–∫`, 'warning');
        });

        jitsiApi.addEventListener('audioMuteStatusChanged', (muted) => {
            const btn = document.getElementById('toggle-audio');
            btn.innerHTML = muted.muted ? 'üé§‚ùå' : 'üé§';
            btn.title = muted.muted ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
        });

        jitsiApi.addEventListener('videoMuteStatusChanged', (muted) => {
            const btn = document.getElementById('toggle-video');
            btn.innerHTML = muted.muted ? 'üìπ‚ùå' : 'üìπ';
            btn.title = muted.muted ? '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞' : '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞';
        });

    } catch (error) {
        console.error('Jitsi initialization error:', error);
        updateCallStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫', 'error');
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–º
function toggleAudio() {
    if (jitsiApi) jitsiApi.executeCommand('toggleAudio');
}

function toggleVideo() {
    if (jitsiApi) jitsiApi.executeCommand('toggleVideo');
}

function toggleScreenShare() {
    if (jitsiApi) jitsiApi.executeCommand('toggleShareScreen');
}

function toggleChat() {
    if (jitsiApi) jitsiApi.executeCommand('toggleChat');
}

function endJitsiCall() {
    if (jitsiApi) {
        jitsiApi.dispose();
    }
    window.location.href = "{{ url_for('chat', chat_id=chat_room.id) }}";
}

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É
function copyRoomLink() {
    const roomLink = `https://meet.jit.si/${roomName}`;
    navigator.clipboard.writeText(roomLink).then(() => {
        showNotification('–£—Å–ø–µ—Ö', '–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
    });
}

function showInviteModal() {
    const roomLink = `https://meet.jit.si/${roomName}`;
    navigator.clipboard.writeText(roomLink).then(() => {
        showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ', '–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.', 'success');
    });
}

// –¢–∞–π–º–µ—Ä –∑–≤–æ–Ω–∫–∞
function startCallTimer() {
    callStartTime = Date.now();
    callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('call-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopCallTimer() {
    if (callTimer) clearInterval(callTimer);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function updateCallStatus(status) {
    document.getElementById('call-status').textContent = status;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('room-name-display').textContent = roomName;
    
    setTimeout(() => {
        startJitsiCall();
    }, 1000);
});
</script>

<style>
.call-controls {
    background: var(--bg-card);
    padding: 16px;
    display: none;
    justify-content: center;
    gap: 12px;
    border-top: 1px solid var(--border);
}

.control-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.control-btn:hover {
    transform: scale(1.1);
}

.end-call-btn {
    background: #ef4444;
    color: white;
}
</style>
{% endblock %}
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∑–≤–æ–Ω–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('room-name-display').textContent = roomName;
    
    // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –∑–≤–æ–Ω–æ–∫
    setTimeout(() => {
        console.log('–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ Jitsi –∑–≤–æ–Ω–∫–∞...');
        startJitsiCall();
    }, 2000);
});

// –î–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ Jitsi API
window.addEventListener('error', function(e) {
    if (e.filename && e.filename.includes('external_api.js')) {
        console.error('Jitsi API –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è:', e);
        showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', 'error');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
        document.getElementById('loading-state').innerHTML += `
            <button class="btn btn-primary" onclick="retryJitsi()" style="margin-top: 20px;">
                üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        `;
    }
});

function retryJitsi() {
    location.reload();
}
