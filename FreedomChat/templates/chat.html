{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 16px;">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" 
               style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; padding: 10px;">
                ‚Üê
            </a>
            <div>
                <h1 style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">{{ chat_room.name }}</h1>
                <div style="font-size: 14px; opacity: 0.9;">
                    {% if chat_room.is_private %}
                    üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç ‚Ä¢ {{ chat_room.members|length }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    {% else %}
                    üåê –ü—É–±–ª–∏—á–Ω—ã–π —á–∞—Ç ‚Ä¢ {{ chat_room.members|length }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; align-items: center;">
            <div id="typing-indicator" style="font-size: 12px; opacity: 0.7; display: none;"></div>
            <a href="{{ url_for('video_call', chat_id=chat_room.id) }}" class="btn btn-secondary" 
               style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; padding: 10px 16px;">
               üìû –ó–≤–æ–Ω–æ–∫
            </a>
        </div>
    </div>

    <!-- Messages -->
    <div class="chat-messages" id="messages-container">
        {% for message in messages %}
            {% if message.message_type == 'voice' %}
            <!-- Voice Message -->
            <div class="message {% if message.author.id == current_user.id %}own{% endif %}" data-message-id="{{ message.id }}">
                <div class="voice-message">
                    <div class="message-header">
                        <span class="message-author">{{ message.author.username or message.author.email.split('@')[0] }}</span>
                        <span class="message-time">{{ message.timestamp.strftime('%H:%M') }}</span>
                    </div>
                    <div class="voice-player">
                        <button class="play-btn" onclick="playVoiceMessage('{{ message.file_path }}', this)">
                            ‚ñ∂Ô∏è
                        </button>
                        <div class="voice-waveform">
                            <div style="font-size: 14px; opacity: 0.9;">
                                üé§ {{ message.duration }}s
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% elif message.message_type in ['file', 'image'] %}
            <!-- File Message -->
            <div class="message {% if message.author.id == current_user.id %}own{% endif %}" data-message-id="{{ message.id }}">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">{{ message.author.username or message.author.email.split('@')[0] }}</span>
                        <span class="message-time">{{ message.timestamp.strftime('%H:%M') }}</span>
                    </div>
                    <div class="file-message">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 12px;">
                            <span style="font-size: 24px;">üìé</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; word-break: break-all;">{{ message.file_name }}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    {{ (message.file_size / 1024 / 1024) | round(2) }} MB
                                </div>
                            </div>
                            <a href="{{ message.file_path }}" download class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                –°–∫–∞—á–∞—Ç—å
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Text Message -->
            <div class="message {% if message.author.id == current_user.id %}own{% endif %}" data-message-id="{{ message.id }}">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">{{ message.author.username or message.author.email.split('@')[0] }}</span>
                        <span class="message-time">{{ message.timestamp.strftime('%H:%M') }}</span>
                    </div>
                    <div class="message-text">
                        {{ message.content }}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Chat Input -->
    <div class="chat-input-wrapper">
        <!-- Voice Recorder -->
        <div id="voice-recorder" style="display: none; background: var(--gradient); color: white; padding: 16px; border-radius: 16px; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 12px; height: 12px; background: white; border-radius: 50%; animation: pulse 1s infinite;"></div>
                    <span>–ó–∞–ø–∏—Å—å...</span>
                    <span id="recording-timer" style="font-weight: 600;">0:00</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="stopRecording()" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); padding: 8px 12px; font-size: 14px;">
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="btn btn-secondary" onclick="cancelRecording()" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); padding: 8px 12px; font-size: 14px;">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>

        <!-- Text Input -->
        <div id="text-input" style="display: flex; gap: 8px; align-items: center; padding: 0 16px 16px;">
            <button class="btn btn-secondary" onclick="toggleVoiceRecorder()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" style="padding: 12px; min-width: 44px;">
                üé§
            </button>
            
            <input type="text" id="message-input" class="form-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                   style="flex: 1; margin: 0; min-height: 44px;"
                   onkeypress="handleKeyPress(event)">
            
            <button class="btn btn-primary" onclick="sendMessage()" style="padding: 12px 20px; min-width: 44px;">
                ‚û§
            </button>
            
            <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" style="padding: 12px; min-width: 44px;">
                üìé
            </button>
        </div>
        
        <input type="file" id="file-input" style="display: none;" onchange="handleFileUpload(this.files[0])" accept="*/*">
    </div>
</div>

<script>
// Socket.IO
const socket = io();
let currentRoom = {{ chat_room.id }};
let typingTimeout;

// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
socket.emit('join_room', { room: currentRoom });

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
socket.on('new_message', function(data) {
    addMessageToChat(data);
    scrollToBottom();
});

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
socket.on('user_typing', function(data) {
    showTypingIndicator(data.user, data.typing);
});

// –û—à–∏–±–∫–∏
socket.on('error', function(data) {
    showNotification('–û—à–∏–±–∫–∞', data.message, 'error');
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (message) {
        socket.emit('send_message', {
            room: currentRoom,
            message: message,
            type: 'text'
        });
        input.value = '';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        socket.emit('typing', {
            room: currentRoom,
            typing: false
        });
    }
}

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
        return;
    }
    
    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    clearTimeout(typingTimeout);
    socket.emit('typing', {
        room: currentRoom,
        typing: true
    });
    
    typingTimeout = setTimeout(() => {
        socket.emit('typing', {
            room: currentRoom,
            typing: false
        });
    }, 1000);
}

// –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
let mediaRecorder;
let audioChunks = [];
let recordingStartTime;
let recordingTimer;

async function toggleVoiceRecorder() {
    const voiceRecorder = document.getElementById('voice-recorder');
    const textInput = document.getElementById('text-input');
    
    if (voiceRecorder.style.display === 'none') {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendVoiceMessage(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            startRecordingTimer();
            
            voiceRecorder.style.display = 'block';
            textInput.style.display = 'none';
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
        }
    } else {
        stopRecording();
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        resetRecorder();
    }
}

function cancelRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        audioChunks = [];
        resetRecorder();
    }
}

function resetRecorder() {
    const voiceRecorder = document.getElementById('voice-recorder');
    const textInput = document.getElementById('text-input');
    
    voiceRecorder.style.display = 'none';
    textInput.style.display = 'flex';
    clearInterval(recordingTimer);
}

function startRecordingTimer() {
    recordingStartTime = Date.now();
    const timerElement = document.getElementById('recording-timer');
    
    recordingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function sendVoiceMessage(audioBlob) {
    const reader = new FileReader();
    reader.onload = function() {
        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
        
        socket.emit('voice_message', {
            room: currentRoom,
            audio_data: reader.result,
            duration: duration
        });
    };
    reader.readAsDataURL(audioBlob);
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö
function playVoiceMessage(audioPath, button) {
    const audio = new Audio(audioPath);
    audio.play();
    button.innerHTML = '‚è∏Ô∏è';
    button.disabled = true;
    
    audio.onended = function() {
        button.innerHTML = '‚ñ∂Ô∏è';
        button.disabled = false;
    };
    
    audio.onerror = function() {
        button.innerHTML = '‚ñ∂Ô∏è';
        button.disabled = false;
        showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
    };
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
function handleFileUpload(file) {
    if (!file) return;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (50MB)
    if (file.size > 50 * 1024 * 1024) {
        showNotification('–û—à–∏–±–∫–∞', '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 50MB)', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    showNotification('–ó–∞–≥—Ä—É–∑–∫–∞', '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'info');
    
    fetch('/upload_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            socket.emit('send_message', {
                room: currentRoom,
                message: `–§–∞–π–ª: ${data.file_name}`,
                type: 'file',
                file_path: data.file_path,
                file_name: data.file_name,
                file_size: data.file_size
            });
            showNotification('–£—Å–ø–µ—Ö', '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showNotification('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', 'error');
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function addMessageToChat(data) {
    const messagesContainer = document.getElementById('messages-container');
    const messageElement = document.createElement('div');
    
    const userName = data.user_email.split('@')[0];
    const isOwn = data.user_id === {{ current_user.id }};
    const timestamp = new Date(data.timestamp).toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (data.type === 'voice') {
        messageElement.innerHTML = `
            <div class="message ${isOwn ? 'own' : ''}" data-message-id="${data.id}">
                <div class="voice-message">
                    <div class="message-header">
                        <span class="message-author">${userName}</span>
                        <span class="message-time">${timestamp}</span>
                    </div>
                    <div class="voice-player">
                        <button class="play-btn" onclick="playVoiceMessage('${data.file_path}', this)">
                            ‚ñ∂Ô∏è
                        </button>
                        <div class="voice-waveform">
                            <div style="font-size: 14px; opacity: 0.9;">
                                üé§ ${data.duration}s
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.type === 'file') {
        const fileSize = (data.file_size / 1024 / 1024).toFixed(2);
        messageElement.innerHTML = `
            <div class="message ${isOwn ? 'own' : ''}" data-message-id="${data.id}">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${userName}</span>
                        <span class="message-time">${timestamp}</span>
                    </div>
                    <div class="file-message">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 12px;">
                            <span style="font-size: 24px;">üìé</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; word-break: break-all;">${data.file_name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${fileSize} MB
                                </div>
                            </div>
                            <a href="${data.file_path}" download class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                                –°–∫–∞—á–∞—Ç—å
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        messageElement.innerHTML = `
            <div class="message ${isOwn ? 'own' : ''}" data-message-id="${data.id}">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${userName}</span>
                        <span class="message-time">${timestamp}</span>
                    </div>
                    <div class="message-text">
                        ${data.content}
                    </div>
                </div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageElement);
}

function scrollToBottom() {
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator(user, typing) {
    const indicator = document.getElementById('typing-indicator');
    const userName = user.split('@')[0];
    
    if (typing) {
        indicator.textContent = `${userName} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
        indicator.style.display = 'block';
    } else {
        indicator.style.display = 'none';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        setTimeout(() => {
            messageInput.focus();
        }, 100);
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', scrollToBottom);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        scrollToBottom();
    }
});
</script>

<style>
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.chat-input-wrapper {
    background: var(--bg-card);
    border-top: 1px solid var(--border);
}

.file-message {
    margin-top: 8px;
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
    .chat-header {
        padding: 16px 20px;
    }
    
    .chat-header h1 {
        font-size: 18px;
    }
    
    .chat-messages {
        padding: 16px;
    }
    
    #text-input {
        padding: 0 12px 12px;
        gap: 6px;
    }
    
    .btn {
        padding: 10px;
    }
    
    .form-input {
        padding: 12px 14px;
    }
}

@media (max-width: 480px) {
    .voice-recorder {
        padding: 12px;
    }
    
    .voice-recorder > div {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }
    
    .voice-recorder-buttons {
        justify-content: center;
    }
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ */
.btn:focus-visible,
.form-input:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */
.message {
    content-visibility: auto;
}
</style>
{% endblock %}
